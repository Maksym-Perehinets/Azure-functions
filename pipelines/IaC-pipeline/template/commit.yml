steps:
  - task: TerraformInstaller@1
    displayName: "Latest Version of terraform installation"
    workingDirectory: '$(Build.SourcesDirectory)/IaC/main'
    inputs:
      terraformVersion: 'latest'
  - task: TerraformTaskV4@4
    displayName: terraform init
    inputs:
      provider: 'azurerm'
      command: 'init'
      backendServiceArm: 'terraform-backend'
      backendAzureRmResourceGroupName: 'ocr-remote-tf-back-end'
      backendAzureRmStorageAccountName: 'remotetfbac324r4njrf'
      backendAzureRmContainerName: 'tfstate'
      backendAzureRmKey: 'terraform.tfstate'

  # Select terraform workspace
  - task: Bash@3
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
    displayName: Create and use terraform production workspace
    workingDirectory: '$(Build.SourcesDirectory)/IaC/main'
    inputs:
      targetType: inline
      script: terraform workspace new prod && terraform workspace select prod
  - task: Bash@3
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/dev')
    displayName: Create and use terraform development workspace
    workingDirectory: '$(Build.SourcesDirectory)/IaC/main'
    inputs:
      targetType: inline
      script: terraform workspace new dev && terraform workspace select dev

  # Code validation
  - task: TerraformTaskV4@4
    displayName: terraform validate
    workingDirectory: '$(Build.SourcesDirectory)/IaC/main'
    inputs:
      provider: 'azurerm'
      command: 'validate'
  # Terraform plan
  - task: TerraformTaskV4@4
    displayName: terraform plan
    workingDirectory: '$(Build.SourcesDirectory)/IaC/main'
    inputs:
      provider: 'azurerm'
      command: 'plan'
      environmentServiceNameAzureRM: 'Azure for Students (12c692a0-00e1-447a-8d87-2712018a0472)'
      commandOptions: >- 
                        -var="location=$(location)"
  # Terraform apply
#  - task: TerraformTaskV4@4
#    displayName: terraform apply
#    workingDirectory: '$(Build.SourcesDirectory)/IaC/main'
#    inputs:
#      provider: 'azurerm'
#      command: 'apply'
#      environmentServiceNameAzureRM: 'Azure for Students (12c692a0-00e1-447a-8d87-2712018a0472)'
#      commandOptions: >-
#                        -auto-approve
#                        -var="location=$(location)"
